{% extends "page.html" %}

{% block htmltitle -%}
<title>Search Results - {{ docstitle|striptags|e }}</title>
{% endblock %}

{% block content -%}
<style>
  .title-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
  }

  .description {
    margin: 5px 0;
    font-style: italic;
  }

  .chip {
    background-color: #E13834;
    border-radius: 5px;
    padding: 3px 10px;
    font-size: 12px;
    color: white;
    font-weight: bold;
  }
</style>

<div id="search-results">
  <h2>Search Results</h2>
  <p class="search-summary"></p>
  <ul class="search"></ul>
</div>
{% endblock %}

{% block scripts -%}
{{ super() }}
<script>
  function formatResultContent(result, fieldName) {
    let highlight = result.highlight[fieldName];

    if (highlight) {
      highlight = highlight.join("... ");

      if (fieldName === "content") {
        highlight += "...";
      }

      return highlight;
    }

    var summary = result.source[fieldName].substring(0, 250);
    if (summary.length < result.source[fieldName].length) {
      summary += "...";
    }
    return summary
  }

  window.onload = function () {
    var urlParams = new URLSearchParams(window.location.search);
    var query = urlParams.get("q");

    $('input.sidebar-search').attr('value', query);

    var searchSummary = $('#search-results .search-summary');
    var searchResults = $('#search-results .search');

    $.get("/.netlify/functions/search?" + $.param({query: query}))
    .done(function(data) {
      if (data.results.length === 0) {
        searchSummary.html("Your search did not match any documents.");
      } else {
        searchSummary.html("Search finished, found " + data.results.length + " page(s) matching the search query.");
      }

      for (var i = 0; i < data.results.length; i++) {
        var result = data.results[i];

        var container = $("<li/>");

        var titleContainer = $("<div/>");
        titleContainer.addClass("title-container")
        container.append(titleContainer);

        var link = $("<a/>");
        link.attr("href", result.source.url);
        link.html(formatResultContent(result, "title"));
        titleContainer.append(link);

        if (result.source.source === "helpcenter") {
          var chip = $("<span/>");
          chip.text("Help Center");
          chip.addClass("chip");
          titleContainer.append(chip);
        }

        if (result.source.description) {
          var description = $("<div/>");
          description.addClass("description")
          description.html(formatResultContent(result, "description"));
          container.append(description);
        }

        var context = $("<div/>");
        context.addClass("context")
        context.html(formatResultContent(result, "content"));
        container.append(context);

        searchResults.append(container);
      }
    })
    .fail(function(e) {
      console.error(e);
      searchSummary.html("Could not get search results. Please try again later.");
    });
  };
</script>

{%- endblock %}
